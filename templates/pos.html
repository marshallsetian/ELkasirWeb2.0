{% extends "layout.html" %}
{% block content %}
<div class="container mt-2">
  <h4 class="text-center fw-bold mb-3">ELKasirWeb 2.0</h4>

  <!-- Cari Produk -->
  <div class="mb-4 position-relative">
    <input type="text" id="search" class="form-control oval-input ps-4" placeholder="Cari Produk..." autocomplete="off">
    <ul id="search-dropdown" class="list-group position-absolute w-100 mt-1 shadow-sm rounded" 
        style="z-index:1000; display:none; max-height:220px; overflow-y:auto; font-size:0.8rem;">
    </ul>
  </div>

  <!-- Keranjang -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-dark text-white fw-bold">Keranjang</div>
    <div class="card-body p-2" id="cart-items" style="max-height:300px; overflow-y:auto;"></div>
    <div class="card-footer p-2">
      <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between small"><span>Total</span><div id="subtotal">Rp 0</div></li>
        <li class="list-group-item d-flex justify-content-between small"><span>Diskon</span><div id="discount-value">Rp 0</div></li>
        <li class="list-group-item d-flex justify-content-between small"><span>Bayar</span><div id="cart-paid-display">Rp 0</div></li>
        <li class="list-group-item d-flex justify-content-between fw-bold"><span>Subtotal</span><span id="total">Rp 0</span></li>
        <li class="list-group-item d-flex justify-content-between small"><span>Kembalian</span><div id="change">Rp 0</div></li>
      </ul>
    </div>
  </div>

  <!-- Diskon & Bayar -->
  <div class="row g-2 mb-3">
    <div class="col-6"><input type="number" id="discount" class="form-control oval-input" placeholder="Diskon %" min="0" max="100"></div>
    <div class="col-6"><input type="text" id="paid" class="form-control oval-input" placeholder="Bayar Rp"></div>
  </div>

  <!-- Dropdown Kasir -->
  <div class="mb-3">
    <select id="kasir_name" name="kasir_name" class="form-select modern-select w-100" required>
      <option value="" disabled selected>Pilih Kasir</option>
      {% for c in cashiers %}
        <option value="{{ c.name }}">{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div id="invoiceData"
       data-tx_id="TEMP"
       data-items="{{ cart_json }}"
       data-subtotal="{{ subtotal }}"
       data-discount="{{ discount }}"
       data-total="{{ total }}"
       data-paid="{{ paid }}"
       data-change="{{ change }}"
       data-kasir_name="">
  </div>

<div class="d-grid">
  <button type="submit" id="processTransaction" class="btn-gradient-pro">
    <i class="bi bi-cash-stack me-1"></i> Proses Transaksi
  </button>
</div>

<style>

.btn-gradient-pro {
  background: linear-gradient(135deg, #6cc7dd, #4382e0);
  color: #fff;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

/* Efek hover */
.btn-gradient-pro:hover {
  background: linear-gradient(135deg, #19b586, #28a745);
  transform: translateY(-2px);
  box-shadow: 0 5px 12px rgba(0,0,0,0.25);
}

/* Efek klik */
.btn-gradient-pro:active {
  transform: scale(0.96);
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
</style>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let cart = [];

const formatRupiah = num => (!num ? "0" : num.toLocaleString('id-ID',{minimumFractionDigits:0}));
const parseRupiah = str => parseInt(str.toString().replace(/\./g,'')) || 0;

// Render keranjang
function renderCart(){
  let cartDiv = document.getElementById("cart-items");
  cartDiv.innerHTML = "";
  if(cart.length === 0){
    cartDiv.innerHTML = `<div class="text-center text-muted small py-3">Keranjang kosong</div>`;
    ["subtotal","discount-value","total","cart-paid-display","change"].forEach(id => document.getElementById(id).innerText="Rp 0");
    return;
  }

  let subtotal = 0;
  cart.forEach((item,index)=>{
    let itemSubtotal = item.price*item.qty;
    subtotal += itemSubtotal;
    let card = document.createElement("div");
    card.className="card mb-2 shadow-sm";
    card.innerHTML=`
      <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
        <div><div class="fw-bold small">${item.name}</div></div>
        <div class="text-end">
          <div class="fw-bold small mb-1">Rp ${formatRupiah(itemSubtotal)}</div>
          <div class="d-flex align-items-center justify-content-end gap-1">
            <button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="decreaseQty(${index})">âˆ’</button>
            <span class="small px-2">${item.qty}</span>
            <button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="increaseQty(${index})">+</button>
          </div>
        </div>
      </div>`;
    cartDiv.appendChild(card);
  });

  let discountPercent = parseInt(document.getElementById("discount").value)||0;
  let discountValue = subtotal*(discountPercent/100);
  let total = subtotal-discountValue;
  let paid = parseRupiah(document.getElementById("paid").value);
  let change = paid - total;

  document.getElementById("subtotal").innerText="Rp "+formatRupiah(subtotal);
  document.getElementById("discount-value").innerText="Rp "+formatRupiah(discountValue);
  document.getElementById("total").innerText="Rp "+formatRupiah(total);
  document.getElementById("cart-paid-display").innerText="Rp "+formatRupiah(paid);
  document.getElementById("change").innerText="Rp "+formatRupiah(change);
}


/* ---------- helper ---------- */
const notify = (opts) => Swal.fire(opts);

const parseIntSafe = v => {
  if (v === null || v === undefined) return 0;
  // ambil hanya digit (hilangkan "pcs","x", titik ribuan, dsb)
  const s = String(v).replace(/[^\d]/g, '');
  return s === '' ? 0 : parseInt(s, 10);
};

// refresh stock terbaru dari server (fallback menggunakan search by name)
async function refreshStockForCartItem(i) {
  try {
    const name = cart[i].name || "";
    if (!name || name.length < 2) return;
    const res = await fetch(`/api/products/search?q=${encodeURIComponent(name)}`);
    if (!res.ok) return;
    const data = await res.json();
    // cari produk yang cocok (bisa match id atau nama)
    const p = data.find(x => Number(x.id) === Number(cart[i].id) || x.name === cart[i].name);
    if (p) {
      cart[i].stock = Math.max(0, (parseInt(p.stock) || 0) - (parseInt(p.sold) || 0));
    }
  } catch (e) {
    console.error("refreshStockForCartItem error", e);
  }
}

/* ---------- Qty control (validasi stok) ---------- */
// note: increaseQty async karena mungkin perlu refresh stok
async function increaseQty(i) {
  if (!cart[i]) return;
  let current = parseIntSafe(cart[i].qty);
  let stock = parseIntSafe(cart[i].stock);

  // jika stock belum di-set atau 0, coba refresh dari server
  if (stock <= 0) {
    await refreshStockForCartItem(i);
    stock = parseIntSafe(cart[i].stock);
  }

  const name = cart[i].name || "Produk";

  if (stock <= 0) {
    notify({ icon: 'warning', title: 'Stok Kosong', text: `Stok ${name} kosong` });
    // clamp supaya tidak negatif
    cart[i].qty = 0;
    renderCart();
    return;
  }

  // boleh tambah hanya bila current < stock
  if (current + 1 > stock) {
    notify({ icon: 'warning', title: 'Stok Tidak Cukup', text: `Stok ${name} hanya tersisa ${stock}` });
    cart[i].qty = stock; // clamp
  } else {
    cart[i].qty = current + 1;
  }

  renderCart();
}

function decreaseQty(i) {
  if (!cart[i]) return;
  let current = parseIntSafe(cart[i].qty);
  if (current > 1) {
    cart[i].qty = current - 1;
  } else {
    cart.splice(i, 1); // hapus item
  }
  renderCart();
}

// input manual (oninput / onchange)
async function onQtyInput(i, rawValue) {
  if (!cart[i]) return;
  let value = parseIntSafe(rawValue);
  let stock = parseIntSafe(cart[i].stock);

  if (stock <= 0) {
    await refreshStockForCartItem(i);
    stock = parseIntSafe(cart[i].stock);
  }

  const name = cart[i].name || "Produk";

  if (value < 1) {
    cart[i].qty = 1;
  } else if (value > stock) {
    notify({ icon:'warning', title:'Stok Tidak Cukup', text: `Stok ${name} hanya tersisa ${stock}` });
    cart[i].qty = stock;
  } else {
    cart[i].qty = value;
  }
  renderCart();
}

/* ---------- Autocomplete (modifikasi) ---------- */
const searchInput = document.getElementById("search");
const searchDropdown = document.getElementById("search-dropdown");

searchInput.addEventListener("input", function(){
  let q = this.value.trim();
  if (q.length < 2){ searchDropdown.style.display = "none"; searchDropdown.innerHTML = ""; return; }
  fetch(`/api/products/search?q=${encodeURIComponent(q)}`)
    .then(res => res.json())
    .then(data => {
      searchDropdown.innerHTML = "";
      if (!Array.isArray(data) || data.length === 0) { searchDropdown.style.display = "none"; return; }
      data.forEach(p => {
        let stock = Math.max(0, (parseInt(p.stock) || 0) - (parseInt(p.sold) || 0));
        let li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.textContent = `${p.name} - Rp ${formatRupiah(p.price)} (Sisa: ${stock})`;
        li.style.cursor = "pointer";

        li.addEventListener("click", () => {
          if (stock <= 0) {
            Swal.fire({icon:'warning', title:'Stok Kosong', text:`Stok ${p.name} kosong`});
            return;
          }

          let cartItem = cart.find(c => Number(c.id) === Number(p.id));
          if (cartItem) {
            // update stok snapshot and validasi
            cartItem.stock = stock;
            if (parseIntSafe(cartItem.qty) + 1 > stock) {
              Swal.fire({icon:'warning', title:'Stok Tidak Cukup', text:`Stok ${p.name} tidak cukup`});
              return;
            }
            cartItem.qty = parseIntSafe(cartItem.qty) + 1;
          } else {
            cart.push({
              id: p.id,
              name: p.name,
              price: p.price,
              qty: 1,
              stock: stock   // penting: simpan sisa stok saat ditambahkan
            });
          }

          renderCart();
          searchDropdown.style.display = "none";
          searchDropdown.innerHTML = "";
          searchInput.value = "";
        });

        searchDropdown.appendChild(li);
      });
      searchDropdown.style.display = "block";
    })
    .catch(err => { console.error(err); searchDropdown.style.display = "none"; });
});


// Diskon & bayar realtime
document.getElementById("discount").addEventListener("input", renderCart);
document.getElementById("paid").addEventListener("input", function(){this.value=formatRupiah(parseRupiah(this.value)); renderCart();});

// Proses transaksi
document.getElementById('processTransaction').addEventListener('click', function(e){
    e.preventDefault();
    const kasirSelect=document.getElementById("kasir_name");
    if(!kasirSelect.value){Swal.fire({icon:'warning',title:'Pilih Kasir',text:'Harap pilih kasir terlebih dahulu!'}); return;}
    if(cart.length===0){Swal.fire({icon:'warning',title:'Keranjang Kosong',text:'Tambahkan produk terlebih dahulu!'}); return;}

    let subtotal=0; cart.forEach(item=>subtotal+=item.price*item.qty);
    let discountPercent=parseInt(document.getElementById("discount").value)||0;
    let discountValue=subtotal*(discountPercent/100);
    let total=subtotal-discountValue;
    let paidAmount=parseRupiah(document.getElementById("paid").value);
    let change=paidAmount-total;

    fetch("/pos/create_transaction",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            items:cart,
            subtotal:subtotal,
            discount:discountPercent,
            total:total,
            paid:paidAmount,
            change:change,
            kasir_name:kasirSelect.value
        })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.status==="ok"){ window.open("/invoice/"+data.tx_id,"_blank"); cart=[]; renderCart();}
        else Swal.fire({icon:'error',title:data.message||"Gagal menyimpan transaksi"});
    })
    .catch(err=>Swal.fire({icon:'error',title:'Gagal',text:'Terjadi kesalahan saat menampilkan invoice'}));
});

// Render awal
renderCart();
</script>
{% endblock %}
